# ä¸»ç¨‹åº

æ¯ç§è¿è¡Œç¯å¢ƒéƒ½ä¼šæœ‰ä¸€ä¸ªä¸»ç¨‹åºå¯¹è±¡ï¼Œä½ å¯ä»¥åœ¨è¿™ä¸ªå¯¹è±¡æ·»åŠ æ’ä»¶å’Œä¸­é—´ä»¶

æ‰€æœ‰è¿è¡Œç¯å¢ƒçš„ä¸»ç¨‹åºéƒ½ç»§æ‰¿äº `Startup` ç±»

æ–‡æ¡£ç§çš„ `startup` å‡è¡¨ç¤ºä¸»ç¨‹åºå®ä¾‹å¯¹è±¡ï¼Œä½†å¹¶ä¸ç‰¹æŒ‡è¿è¡Œç¯å¢ƒ

## Startup

ä¸ºäº†è®© sfa èƒ½å¤Ÿåœ¨å„ç±»ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œ`Startup`ç±»è®¾è®¡çš„è¾ƒä¸ºå¼€æ”¾ï¼Œåœ¨ ts ä¸­æ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œå› æ­¤è¯¥ç±»ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦å®šä¹‰æ´¾ç”Ÿç±»å¹¶åœ¨åˆé€‚çš„å‡½æ•°ä¸­è°ƒç”¨ `invoke` å‡½æ•°ã€‚

`@sfajs/core` æä¾›äº†ä¸€ä¸ª `TestStartup` ç±»ï¼Œè¯¥ç±»æ²¡æœ‰ä»»ä½•è¿è¡Œç¯å¢ƒï¼Œæ–¹ä¾¿ç”¨äºå•å…ƒæµ‹è¯•

ç›®å‰å·²æ”¯æŒçš„è¿è¡Œç¯å¢ƒå¦‚ä¸‹ï¼š

- [@sfajs/cloudbase](https://github.com/sfajs/cloudbase): å°† sfa æ‰˜ç®¡åˆ°è…¾è®¯äº‘ CloudBase
- [@sfajs/alifunc](https://github.com/sfajs/alifunc): å°† sfa æ‰˜ç®¡åˆ°é˜¿é‡Œäº‘å‡½æ•°è®¡ç®—
- [@sfajs/http](https://github.com/sfajs/http): å°† sfa æ‰˜ç®¡åˆ° http(s) ç¯å¢ƒ

> ğŸ‰ æ›´å¤šç¯å¢ƒæ¬¢è¿è´¡çŒ®å¹¶ç¼–è¾‘æ­¤ [README](https://github.com/sfajs/website/edit/main/docs/usage/startup.md) ä»¥æ·»åŠ 

## HttpContext

è¯·æ±‚ç®¡é“ä¸­çš„å†…å®¹éƒ½åœ¨ `HttpContext` å¯¹è±¡ä¹‹ä¸­ï¼Œæ¯ä¸ªä¸­é—´ä»¶éƒ½å¯ä»¥è°ƒç”¨ `this.ctx` æ¥è·å–æˆ–ä¿®æ”¹ç®¡é“å†…å®¹

è¯¥å¯¹è±¡åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

- res å­—æ®µ: `SfaResponse` å®ä¾‹å¯¹è±¡
- req å­—æ®µ: `SfaRequest` å®ä¾‹å¯¹è±¡
- bag å‡½æ•°ï¼šç”¨äºåœ¨ç®¡é“ä¸­ä¼ é€’æ›´å¤šå†…å®¹

### SfaResponse

ä½œä¸º API è¿”å›å†…å®¹ï¼ˆåœ¨ Startup å¯èƒ½ä¼šè¢«è§£æåè¿”å›ï¼‰

åŒ…å«ä»¥ä¸‹å†…å®¹

- headers: è¿”å›çš„å¤´éƒ¨
- body: è¿”å›çš„å†…å®¹
- status: è¿”å›çŠ¶æ€ç 
- isSuccess: è¿”å›å€¼æ˜¯å¦æˆåŠŸï¼Œstatus >= 200 && status < 300
- setHeaders: è®¾ç½®å¤šä¸ª header
- setHeader: è®¾ç½®å•ä¸ª header
- hasHeader: åˆ¤æ–­ header æ˜¯å¦å­˜åœ¨ï¼Œå¿½ç•¥ key å¤§å°å†™
- removeHeader: ç§»é™¤ä¸€ä¸ª headerï¼Œå¿½ç•¥ key å¤§å°å†™
- getHeader: è·å–ä¸€ä¸ª header å€¼ï¼Œå¿½ç•¥ key å¤§å°å†™

åœ¨æ¯ä¸ªä¸­é—´ä»¶éƒ½å¯ä»¥ä¿®æ”¹ `this.ctx.res` ä¸­çš„å†…å®¹

#### X-HTTP-Method-Override

å¦‚æœè¯·æ±‚å¤´éƒ¨åŒ…å« `X-HTTP-Method-Override` å‚æ•°ï¼Œåˆ™è®¿é—®æ–¹æ³• `httpMethod` ä»¥ `X-HTTP-Method-Override` å€¼ä¸ºå‡†

æ¯”å¦‚ Action è¦æ±‚ `PATCH` è¯·æ±‚ï¼Œä½†å¾®ä¿¡å°ç¨‹åºä¸æ”¯æŒ `PATCH`ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ `POST` è®¿é—®ï¼Œå¹¶åœ¨å¤´éƒ¨åŠ ä¸Šæ­¤å‚æ•°ï¼Œå€¼ä¸º `PATCH`

```JSON
"headers":{
  "X-HTTP-Method-Override": "PATCH"
}
```

### SfaRequest

åœ¨ä¸­é—´ä»¶ä¸­ï¼Œå¯é€šè¿‡ `this.ctx.req` æ–¹å¼è·å–è¯·æ±‚å†…å®¹

`req` å¯¹è±¡åŒ…å«ä»¥ä¸‹å†…å®¹

- path: è®¿é—®è·¯å¾„ï¼Œä¸å¸¦åŸŸåå’ŒæŸ¥è¯¢å‚æ•°ï¼Œè‡ªåŠ¨å»é™¤å¼€å¤´ `/`
- params: æŸ¥è¯¢å‚æ•°
- body: body å†…å®¹
- headers: è·å– header çš„æ·±æ‹·è´å€¼ï¼Œget å±æ€§
- setHeaders: è®¾ç½®å¤šä¸ª header
- setHeader: è®¾ç½®å•ä¸ª header
- hasHeader: åˆ¤æ–­ header æ˜¯å¦å­˜åœ¨ï¼Œå¿½ç•¥ key å¤§å°å†™
- removeHeader: ç§»é™¤ä¸€ä¸ª headerï¼Œå¿½ç•¥ key å¤§å°å†™
- getHeader: è·å–ä¸€ä¸ª header å€¼ï¼Œå¿½ç•¥ key å¤§å°å†™

### `bag` å‡½æ•°

å¯ä»¥åœ¨ç®¡é“ä¸­ä¼ é€’æ›´å¤šè‡ªå®šä¹‰å†…å®¹ã€‚

å¦‚æœä½¿ç”¨ TSï¼Œå¯ä»¥å€Ÿæ³›å‹ç‰¹æ€§è·å¾—æ›´å¤šæ™ºèƒ½æç¤ºã€‚

sfa æ”¯æŒä¸¤ç§å¼•ç”¨ç±»å‹çš„ bag

- Singleton: å•ä¾‹æ¨¡å¼ï¼Œæ·»åŠ åå¯å¤šæ¬¡è·å–åŒä¸€å¼•ç”¨
- Transient: ä¸´æ—¶æ¨¡å¼ï¼Œæ·»åŠ åæ¯æ¬¡è·å–éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°å¼•ç”¨

å¦‚æœæ˜¯å€¼ç±»å‹ï¼Œæ¯æ¬¡è·å–çš„éƒ½æ˜¯è¯¥å€¼çš„æ‹·è´

#### æ·»åŠ æˆ–ä¿®æ”¹ `bag`

```JS
// Singleton
this.ctx.bag("BAG_NAME", { /*bag content*/ });
```

OR

```JS
// Transient
this.ctx.bag("BAG_NAME", () => { /*bag content*/ });
```

#### è·å– `bag`

```JS
const val = this.ctx.bag("BAG_NAME")
```

æˆ– TS

```TS
const val = this.ctx.bag<string>("BAG_NAME")
```
